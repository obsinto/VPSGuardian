#!/bin/bash

# Reseta completamente
sudo ufw --force reset

# Pol√≠tica padr√£o
sudo ufw default deny incoming
sudo ufw default allow outgoing

# Loopback (essencial)
sudo ufw allow in on lo
sudo ufw allow out on lo

# HTTP/HTTPS (Coolify - P√∫blico)
sudo ufw allow 80/tcp comment 'HTTP'
sudo ufw allow 443/tcp comment 'HTTPS'

# SSH - Localhost
sudo ufw allow from 127.0.0.1 to any port 22 comment 'SSH localhost'

# SSH - LAN
sudo ufw allow from 192.168.31.0/24 to any port 22 comment 'SSH LAN'

# SSH - Redes Docker (para Coolify gerenciar o servidor)
sudo ufw allow from 10.0.0.0/8 to any port 22 comment 'SSH Docker networks'

# Ativa
sudo ufw enable

# Verifica
echo ""
echo "=========================================="
echo "  ‚úÖ UFW Configurado com Sucesso"
echo "=========================================="
sudo ufw status numbered

echo ""
echo "üß™ Testando conectividade..."
echo ""
echo "1Ô∏è‚É£ Docker ‚Üí Internet:"
docker run --rm --network coolify alpine sh -c "wget -qO- https://api.github.com/zen" && echo "‚úÖ Internet OK" || echo "‚ùå Internet Falhou"

echo ""
echo "2Ô∏è‚É£ Docker ‚Üí Host SSH:"
docker run --rm --network coolify --add-host=host.docker.internal:host-gateway alpine sh -c "apk add --no-cache netcat-openbsd && nc -z -w 5 host.docker.internal 22" && echo "‚úÖ SSH (Porta 22 Host) OK" || echo "‚ùå SSH (Porta 22 Host) Falhou" funciona

echo ""
echo "üéâ Tudo configurado! Pode testar deploy no Coolify!"
