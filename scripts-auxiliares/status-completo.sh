#!/bin/bash
################################################################################
# Script de Status Completo
# Propรณsito: Dashboard unificado mostrando status do VPS, Docker, Coolify,
#            backups e manutenรงรฃo
################################################################################

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ          STATUS COMPLETO DO VPS + COOLIFY                  โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

echo "๐ $(date '+%A, %d de %B de %Y - %H:%M:%S')"
echo "๐ฅ๏ธ  Hostname: $(hostname)"
echo ""

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐พ DISCO"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
df -h / | tail -1 | awk '{print "  Usado: "$3" de "$2" ("$5")"}'
echo ""

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐ง MEMรRIA"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
free -h | grep Mem | awk '{print "  Usado: "$3" de "$2" ("int($3/$2*100)"%)"}'
echo ""

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐ณ DOCKER"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
docker system df 2>/dev/null || echo "  Docker nรฃo disponรญvel"
echo ""

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐ COOLIFY"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
if docker ps --format '{{.Names}}' | grep -q "coolify"; then
    echo "  Status: โ Rodando"
    COOLIFY_VERSION=$(docker ps --filter "name=coolify" --format '{{.Image}}' | grep coollabsio/coolify | head -n1)
    echo "  Versรฃo: $COOLIFY_VERSION"
else
    echo "  Status: โ Nรฃo estรก rodando"
fi
echo ""

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐ฆ รLTIMA MANUTENรรO"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
if [ -f /var/log/manutencao/manutencao.log ]; then
    tail -5 /var/log/manutencao/manutencao.log | sed 's/^/  /'
else
    echo "  Nenhuma manutenรงรฃo registrada"
fi
echo ""

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐พ รLTIMO BACKUP"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
if [ -d /root/coolify-backups ]; then
    ULTIMO_BACKUP=$(ls -t /root/coolify-backups/*.tar.gz 2>/dev/null | head -1)
    if [ -n "$ULTIMO_BACKUP" ]; then
        echo "  Arquivo: $(basename $ULTIMO_BACKUP)"
        echo "  Tamanho: $(du -h $ULTIMO_BACKUP | cut -f1)"
        echo "  Data: $(stat -c %y $ULTIMO_BACKUP | cut -d'.' -f1)"
        echo "  Total de backups: $(ls -1 /root/coolify-backups/*.tar.gz 2>/dev/null | wc -l)"
    else
        echo "  Nenhum backup encontrado"
    fi
else
    echo "  Diretรณrio de backups nรฃo existe"
fi
echo ""

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐ UPDATES PENDENTES"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
UPDATES=$(apt list --upgradable 2>/dev/null | grep -c "upgradable" || echo "0")
echo "  Pacotes para atualizar: $UPDATES"
echo ""

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โฐ PRรXIMAS EXECUรรES AGENDADAS"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "  Backup: Prรณximo domingo รs 02:00"
echo "  Manutenรงรฃo: Prรณxima segunda รs 03:00"
echo "  Verificaรงรฃo: Todo dia รs 09:00"
echo ""
